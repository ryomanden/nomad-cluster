# My Nomad Cluster
なぜNomadのクラスタを構築するに至ったのか、どのような要件を満たすために構築したのか。また、Nomadクラスタの現状の課題についてまとめる。
## 構築のモチベーション
- 様々なOSSと出会い、それらを検証する基盤が必要だった。
- 1ノードのDockerサーバーなどでは可用性に問題があり、サービスを立ち上げたいときにすぐに立ち上げられない可能性がある。
- コンテナのスケーリングなど、コンテナオーケストレーションを学びたかった。

## システムの要件
- 思い立ったらすぐにサービスを立ち上げられる、フットワークの軽いシステムであること。
- 常時稼働が必要なサービスを立ち上げることは想定せず、サービスの検証を妨げない程度の可用性があること。
- 基盤のメンテナンスが容易であること。

## 選定
### Nomad
- 機能が少ない代わりに、シンプル・軽量である。
- DockerやPodman以外にJava、Qemuなど非コンテナサービスも実行できる。
- 周りに使っている人がいなかったので、使ってみたかった。
### Consul
- サービスディスカバリとして選定。
- Nomadとの連携が簡単である。
### Traefik
- リバースプロキシ・ロードバランサとして選定。
- 外部からのアクセスを受け付ける。
- ```tags```にルールを記述することで、サービスの自動登録が可能。
- Consulとの連携が簡単である。
### Cloudflared・Cloudflare Tunnel
- 外部からのアクセスをTunnelを介してTraefikに渡す。
- CloudflareのDNSに直接設定できるため、DNSの設定が容易である。
- Zero Trust Networkの構築が容易である。
### SMB CSI
- Nomadマシンのスペックが低く、CephやMinIOを構築できないため、やむなくSMBを採用。
- SMBのホストマシンは、以前から稼働しているDockerサーバー。
## Tailscale VPN
- 管理端末からアクセスするために選定。
- 接続が容易である。
- 必要であれば共有リンクを発行でき、Tailscale上でACLを設定できるため、管理が容易である。
### Vault・1Password（構築中）
- シークレット管理として選定。
- Vaultと1Passwordを連携できるらしく、試してみたい。

## 構成
以下は、現在の構成図である。あくまで動作のイメージであり、実際には各ホストマシン上で個別にアプリケーションが動作し、それぞれが連携している。
![構成図](assets/Nomad_cluster.png)

## 結果・課題
